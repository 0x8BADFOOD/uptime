<script id="event_template" type="text/template">
<li>
  <span class="label">{{= new Date(event.timestamp).toLocaleTimeString() }}</span>
  {{ var label = (event.message == 'paused' || event.message == 'restarted') ? 'info' : (event.message == 'up') ? 'success' : 'important' }}
  <span class="label label-{{= label }}">{{= event.message }}</span>
  <a href="{{=  route + '/check/' + event.check._id }}">{{= event.check.name }}</a>
  <a href="{{= event.check.url }}" target="_blank"><img src="{{= route }}/images/external-link-ltr-icon.png"></a>
  {{ if (event.message == 'paused' || event.message == 'restarted') { }}
    <span class="blue">was {{= event.message }}</span>
  {{ } else { }}
    {{= (event.message == 'down') ? 'went down' : event.downtime ? 'went back up' : 'is now up' }}
    {{ if (event.message == 'up' && event.downtime) { }}
    after {{= $.timeago.inWords(event.downtime) }} of downtime
    {{ } }}
  {{ } }}
</li>
</script>
<script>
$(document).ready(function() {
  $.timeago.settings.strings.suffixAgo = null;
  var event_template = document.getElementById('event_template').innerHTML;
  var ejs = require('ejs');
  ejs.open = '{{';
  ejs.close = '}}';
  var updateEvents = function() {
    $.getJSON('<%= url %>', function(events) {
      if ($.isEmptyObject(events)) {
        $('#events').html('<p>Nothing happened lately. All Green!</p>');
        return;
      }
      var lines = [];
      $.each(events, function(key, eventGroup) {
        lines.push('<ul><li class="day"><h3>' + key + '</h3><ul>');
        $.each(eventGroup, function(key, event) {
          if (!event.message) return;
          lines.push(ejs.render(event_template, { event: event, route: '<%= route %>' }));
        });
        lines.push('</ul></li></ul>');
      });
      $('#events').html(lines.join(''));
    });
  }
  socket.on('CheckEvent', updateEvents);
  updateEvents();
});
</script>
